# Avalon Meta-Model Specification

Документ описывает внутреннюю метамодель Avalon — систему, отвечающую за динамическое создание сущностей, их свойств, методов, атрибутов и наследования.  
Эта модель определяет, как система интерпретирует классы, формирует API и строит структуры данных.

Документ используется как основа для дальнейшего расширения AI-помощником.

---

# 1. Базовые сущности метамодели

## 1.1. `sys_class` — описание класса (метасущности)

Таблица описывает типы сущностей в системе. Каждая запись — это определение класса.

### Поля:
| поле | описание |
|------|----------|
| `class_uid` | уникальный идентификатор класса |
| `metaclass_id` | UID метакласса, к которому относится сущность |
| `class_code` | системный код класса |
| `class_descr` | человекочитаемое имя |

### Примеры классов:
- `Class` — базовая метасущность
- `Inheritance` — связь наследования
- `Assoc` — ассоциация
- `Composition`
- `Aggregation`
- `Attr` — атрибут
- `Method` — метод
- `Document` — базовый документ
- `Contract` — документ, наследующий Document
- `Invoice` — документ, наследующий Document

---

# 2. Свойства классов (`sys_class_feature`)

Описывает свойства (features) классов: атрибуты, методы, связи.

### Поля:
| поле | описание |
|------|----------|
| `feature_uid` | UID свойства |
| `class_uid` | класс-владелец |
| `feature_type_uid` | тип свойства (`Attr`, `Method`, `Assoc`, ...) |
| `code` | системное имя |
| `descr` | описание |
| `datatype` | тип данных (для Attr) |
| `visibility` | public/private |
| `is_inherited` | фича наследована или создана вручную |
| `inherited_from` | UID класса, из которого унаследовано |

### Примеры фич документа:
- `docNumber: varchar`
- `docDate: date`
- `amount: numeric`
- методы: `printDocument`, `validateDocument`

### Наследованные фичи
Например: Contract и Invoice унаследовали `docNumber`, `docDate`, `amount`.

Поле `is_inherited = true`.

---

# 3. Наследование (`sys_class_inher`)

Описывает древовидную модель наследования.

### Поля:
| поле | описание |
|------|----------|
| `parent_uid` | родительский класс |
| `child_uid` | дочерний класс |

### Пример:

---

# 4. Механизм наследования (триггеры и функции)

Система автоматически поддерживает ООП-наследование.

## 4.1. При добавлении feature родителю  
Триггер `sys_trg_inherit_feature_insert`:

- копирует feature во всех потомков
- отмечает её как `is_inherited = true`
- вызывает рекурсию на всех уровнях вложенности

## 4.2. При удалении feature у родителя  
Триггер `sys_trg_delete_inherited_feature`:

- удаляет все наследованные duplicates у потомков
- выполняет рекурсивный обход дерева наследования

## 4.3. Полная рекурсивная процедура  
`sys_inherit_features_recursive`:

- заново создаёт наследование для всех классов Inheritance
- используется при пересборке или миграциях

---

# 5. Примеры структуры классов

## 5.1. Document (базовый документ)
Атрибуты:
- docNumber: varchar  
- docDate: date  
- amount: numeric  

Методы:
- printDocument  
- validateDocument  

## 5.2. Contract (наследует Document)
Собственные атрибуты:
- contractType: varchar  
- startDate: date  
- endDate: date  

Методы:
- signContract  
- terminateContract  

Унаследованные фичи (is_inherited = true):
- docNumber  
- docDate  
- amount  
- printDocument  
- validateDocument  

## 5.3. Invoice (наследует Document)
Собственные атрибуты:
- invoiceNumber  
- invoiceDate  
- totalAmount  

Методы:
- sendInvoice  
- payInvoice  

Унаследованные:
- docNumber  
- docDate  
- amount  
- printDocument  
- validateDocument  

---

# 6. Семантика типов фич
Типы определяются через `sys_class`:

| feature_type  | назначение |
|---------------|------------|
| `Attr` | Атрибут / поле сущности |
| `Method` | Метод, серверная операция |
| `Assoc` | Ассоциация (связь) |
| `Composition` | Композиция |
| `Aggregation` | Агрегация |
| `Inheritance` | Связь наследования |

---

# 7. Использование в runtime
На основе метамодели система должна:

- генерировать модели данных  
- автоматически формировать таблицы/структуры  
- генерировать REST/GraphQL API  
- генерировать UI формы/таблицы  
- поддерживать автопостроение CRUD  
- обеспечивать наследование поведения  

---

# 8. Что нужно документировать дальше
- schema storage моделей  
- правила генерации API  
- правила генерации UI  
- методы как исполнимые actions  
- реализация композиции/агрегации  
- метамодель workflow  
- поддержка AI автогенерации классов

Документ расширяется по мере развития платформы.
