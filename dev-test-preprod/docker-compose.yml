version: "3.9"
services:
  # =====================
  # Postgres –¥–ª—è –≤—Å–µ—Ö —Å—Ä–µ–¥
  # =====================
  postgres:
    image: postgres:15
    container_name: postgres_devtestpreprod
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"  # Dev
      - "5433:5433"  # Test
      - "5434:5434"  # Preprod

  # =====================
  # Backend API –¥–ª—è Dev/Test/Pre-prod
  # =====================
  backend-dev:
    image: avalon/backend:latest
    environment:
      ENV: dev
      DB_HOST: postgres
      DB_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5000:5000"
    depends_on:
      - postgres

  backend-test:
    image: avalon/backend:latest
    environment:
      ENV: test
      DB_HOST: postgres
      DB_PORT: 5433
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5001:5001"
    depends_on:
      - postgres

  backend-preprod:
    image: avalon/backend:latest
    environment:
      ENV: preprod
      DB_HOST: postgres
      DB_PORT: 5434
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5002:5002"
    depends_on:
      - postgres

  # =====================
  # Frontend React
  # =====================
  frontend-dev:
    image: avalon/frontend:latest
    environment:
      ENV: dev
    ports:
      - "3000:3000"

  frontend-test:
    image: avalon/frontend:latest
    environment:
      ENV: test
    ports:
      - "3001:3001"

  frontend-preprod:
    image: avalon/frontend:latest
    environment:
      ENV: preprod
    ports:
      - "3002:3002"

  # =====================
  # MinIO —Å Tiering
  # =====================
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    entrypoint: >
      sh -c "
      minio server /data --console-address ':9001' &
      sleep 8 &&
      mc alias set local http://localhost:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} &&
      mc mb -p local/dev local/test local/preprod &&
      mc admin bucket remote add local ${S3_BUCKET} ${S3_ENDPOINT} ${S3_ACCESS_KEY} ${S3_SECRET_KEY} &&
      mc ilm add local/dev --tiering move --limit 300GB --transition-days 30 &&
      mc ilm add local/test --tiering move --limit 300GB --transition-days 30 &&
      mc ilm add local/preprod --tiering move --limit 300GB --transition-days 30 &&
      fg 1
      "
    depends_on:
      - postgres

  # =====================
  # OpenSearch
  # =====================
  opensearch:
    image: opensearchproject/opensearch:2.9.0
    environment:
      discovery.type: single-node
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch_data:/usr/share/opensearch/data

  # =====================
  # Kafka + Zookeeper
  # =====================
  zookeeper:
    image: bitnami/zookeeper:latest
    environment:
      ALLOW_ANONYMOUS_LOGIN: "yes"
    ports:
      - "2181:2181"

  kafka:
    image: bitnami/kafka:latest
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
    ports:
      - "9092:9092"

  # =====================
  # Redis
  # =====================
  redis:
    image: redis:7
    container_name: redis
    restart: always
    ports:
      - "6379:6379"
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    volumes:
      - redis_data:/data

  # =====================
  # CI/CD Runner (GitHub Actions Runner –∏–ª–∏ Jenkins Agent)
  # =====================
  cicd-runner:
    image: ghcr.io/actions/actions-runner:latest
    container_name: cicd_runner
    restart: unless-stopped
    environment:
      RUNNER_NAME: avalon-runner
      RUNNER_REPO: https://github.com/your-org/avalon-dms
      RUNNER_TOKEN: ${GITHUB_RUNNER_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    depends_on:
      - backend-dev
      - backend-test
      - backend-preprod

  # =====================
  # Monitoring (Prometheus + Grafana)
  # =====================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    depends_on:
      - backend-dev
      - backend-test
      - backend-preprod
      - postgres
      - redis
      - minio

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3003:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

  # =====================
  # Healthcheck & Utility Container
  # =====================
  healthcheck:
    image: curlimages/curl:latest
    container_name: healthcheck
    command: >
      sh -c "
      echo '--- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ ---' &&
      curl -s http://backend-dev:5000/health || echo 'Backend DEV –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' &&
      curl -s http://backend-test:5001/health || echo 'Backend TEST –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' &&
      curl -s http://backend-preprod:5002/health || echo 'Backend PREPROD –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' &&
      curl -s http://minio:9000/minio/health/ready || echo 'MinIO –Ω–µ –≥–æ—Ç–æ–≤' &&
      curl -s http://opensearch:9200 || echo 'OpenSearch –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç' &&
      echo '--- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ---'
      "
    depends_on:
      - backend-dev
      - backend-test
      - backend-preprod
      - minio
      - opensearch
    deploy:
      restart_policy:
        condition: on-failure

# =====================
# TOML –∏ DATA VOLUMES
# =====================
volumes:
  pgdata:
    driver: local
    driver_opts:
      type: none
      device: /opt/avalon/data/pgdata
      o: bind
  minio_data:
    driver: local
    driver_opts:
      type: none
      device: /opt/avalon/data/minio_data
      o: bind
  opensearch_data:
    driver: local
    driver_opts:
      type: none
      device: /opt/avalon/data/opensearch_data
      o: bind
  redis_data:
    driver: local
    driver_opts:
      type: none
      device: /opt/avalon/data/redis_data
      o: bind
  prometheus_data:
    driver: local
    driver_opts:
      type: none
      device: /opt/avalon/data/prometheus_data
      o: bind
  grafana_data:
    driver: local
    driver_opts:
      type: none
      device: /opt/avalon/data/grafana_data
      o: bind

# =====================
# NETWORKS
# =====================
networks:
  avalon_net:
    driver: bridge

# =====================
# GLOBAL SERVICE SETTINGS (—Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
# =====================
x-defaults: &default-service
  restart: unless-stopped
  networks:
    - avalon_net
  healthcheck:
    test: ["CMD-SHELL", "echo 'ok'"]
    interval: 30s
    timeout: 10s
    retries: 5

# =====================
# NOTES
# =====================
# üî∏ –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –æ–±—â–µ–π —Å–µ—Ç–∏ avalon_net.
# üî∏ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ .env
# üî∏ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ volumes –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π SSD-–¥–∏—Å–∫:
#     /mnt/avalon_data:/var/lib/docker/volumes
# üî∏ –í –±—É–¥—É—â–µ–º –¥–ª—è Production –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –Ω–æ–¥—ã:
#     - PostgreSQL + Redis -> –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä
#     - MinIO + OpenSearch -> –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
#     - Backend + Frontend -> Application Layer
#     - Kafka + Zookeeper -> Messaging Layer
# üî∏ Prometheus –∏ Grafana –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ backend –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–º –º–µ—Ç—Ä–∏–∫–∞–º
# üî∏ –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å reverse proxy (–Ω–∞–ø—Ä–∏–º–µ—Ä, Traefik –∏–ª–∏ Nginx)
# üî∏ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å backup —Å–µ—Ä–≤–∏—Å:
#     duplicati:
#       image: duplicati/duplicati
#       ports:
#         - "8200:8200"
#       volumes:
#         - /opt/avalon-dms/backups:/data
#         - /opt/avalon-dms:/source
#       restart: unless-stopped
#       environment:
#         - DUPLICATI__PASSWD=<strong_password>
#         - DUPLICATI__WEBSERVICE_PORT=8200
#         - DUPLICATI__WEBSERVICE_INTERFACE=any
#       depends_on:
#         - postgres
#         - minio
#
# –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å:
# docker-compose --env-file .env up -d
# docker logs -f <service_name>  # –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
#
# –î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
# docker-compose down && docker-compose up -d
#
# –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
# docker ps
# docker stats
# docker-compose logs --tail=50 <service>
#
# üöÄ –ì–æ—Ç–æ–≤–æ! –°–∏—Å—Ç–µ–º–∞ Avalon DMS MVP –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ dev/test/preprod –æ–∫—Ä—É–∂–µ–Ω–∏–∏
# –∏ –≥–æ—Ç–æ–≤–∞ –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.